---
- name: install java and net tools
  hosts: nexus_server
  tasks:
    - name: Update repositories cache
      ansible.builtin.apt:
        update_cache: yes
        force_apt_get: true
        cache_valid_time : 3600

    - name: Install the package "java"
      ansible.builtin.apt:
        name: openjdk-8-jre-headless

    - name: Install the package "net-tools"
      ansible.builtin.apt:
        name: net-tools
    
    - name: Install the package "net-tools"
      ansible.builtin.apt:
        name: acl

- name: Download and unpack nexus installer
  hosts: nexus_server
  tasks:
    - name : check nexus folder stats
      ansible.builtin.stat:
        path: /opt/nexus
      register: stat_result
    - debug: msg={{stat_result.stat.exists}}

    - name: Download nexus
      ansible.builtin.get_url: 
        url: https://download.sonatype.com/nexus/3/nexus-3.88.0-08-linux-x86_64.tar.gz
        dest: /opt/
      register: nexus_file
      when: not stat_result.stat.exists
      

    - name: Extract nexus-3.88.0-08-linux-x86_64.tar.gz into /opt/
      ansible.builtin.unarchive:
        src: "{{nexus_file.dest}}"
        dest: /opt/
        remote_src: yes
      when: not stat_result.stat.exists

    - name: Find nexus Folder
      ansible.builtin.find:
        paths: /opt/
        patterns: "nexus-*"
        file_type: directory
      register: find_result

    - name : check nexus folder stats
      ansible.builtin.stat:
        path: /opt/nexus
      register: stat_result
    - debug: msg={{stat_result.stat.exists}}

    - name: Rename nexus folder
      ansible.builtin.shell: mv "{{find_result.files[0].path}}" /opt/nexus
      when: not stat_result.stat.exists


- name: create nexus user for nexus folders
  hosts: nexus_server
  tasks:
    - name: Ensure group "nexus" exists
      ansible.builtin.group:
        name: nexus
        state: present

    - name: Add the user 'nexus' with a specific uid and a primary group of 'admin'
      ansible.builtin.user:
        name: nexus
        comment: nexus user
        group: nexus

    - name: Change nexus file ownership, group and permissions
      ansible.builtin.file:
        path: /opt/nexus
        state: directory
        owner: nexus
        group: nexus
        recurse: yes
    
    - name: Change sonar type file ownership, group and permissions
      ansible.builtin.file:
        path: /opt/sonatype-work
        state: directory
        owner: nexus
        group: nexus
        recurse: yes

- name: start nexus with nexus user
  hosts: nexus_server
  become: true
  become_user: nexus
  tasks:
    - name: set run_as_user nexus
      ansible.builtin.lineinfile:
        path: /opt/nexus/bin/nexus
        regexp: '^#run_as_user:""'
        line: run_as_user="nexus"

    - name: start nexus
      ansible.builtin.command: /opt/nexus/bin/nexus start

- name: verify nexus running
  hosts: nexus_server
  tasks:
    - name: check using ps
      ansible.builtin.shell: ps aux | grep nexus
      register: app_status
    - debug: msg={{app_status.stdout_lines}}

    - name: Pause for 5 minutes to build app cache
      ansible.builtin.pause:
        minutes: 1

    - name: check using netsat
      ansible.builtin.shell: ss -tulnp | grep 8081
      register: app_status
    - debug: msg={{app_status.stdout_lines}}
